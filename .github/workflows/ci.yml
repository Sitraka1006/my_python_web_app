name: Build and Integrate to DockerHub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  docker:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t sitraka001/my_python_web_app-web:latest .

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Push image to DockerHub
        run: |
          docker push sitraka001/my_python_web_app-web:latest

      - name: Deploy locally on VM
        run: |
          echo "Début du déploiement local..."

          DOCKERHUB_USERNAME="${{ secrets.DOCKER_USERNAME }}"
          IMAGE_NAME="my_python_web_app-web"
          TAG="latest"
          FULL_IMAGE="$DOCKERHUB_USERNAME/$IMAGE_NAME:$TAG"
          CONTAINER_NAME="flask-app"
          NETWORK_NAME="flask-network"

          # Sécurité : vérification du secret
          if [ -z "$DOCKERHUB_USERNAME" ]; then
            echo "[ERROR] DOCKER_USERNAME secret non défini"
            exit 1
          fi

          log_info() { echo "[INFO] $1"; }
          log_error() { echo "[ERROR] $1"; }
          log_success() { echo "[SUCCESS] $1"; }

          mkdir -p /opt/flask-app

          log_info "Pull de la dernière image..."
          docker pull "$FULL_IMAGE"

          log_info "Arrêt de l'ancien conteneur (si existant)..."
          docker stop "$CONTAINER_NAME" 2>/dev/null || true
          docker rm "$CONTAINER_NAME" 2>/dev/null || true

          log_info "Création du réseau Docker (si nécessaire)..."
          docker network create "$NETWORK_NAME" 2>/dev/null || true

          log_info "Démarrage du nouveau conteneur..."
          docker run -d \
            --name "$CONTAINER_NAME" \
            --restart unless-stopped \
            --network "$NETWORK_NAME" \
            -p 5000:5000 \
            -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" \
            -e FLASK_ENV=production \
            "$FULL_IMAGE"

          sleep 5

          if docker ps | grep -q "$CONTAINER_NAME"; then
            log_success "Conteneur démarré avec succès"
          else
            log_error "Échec du démarrage du conteneur"
            docker logs "$CONTAINER_NAME"
            exit 1
          fi

          log_info "Nettoyage des images inutilisées..."
          docker image prune -af --filter "until=24h"

          echo "Déployé le $(date) - Commit: ${{ github.sha }}" >> /opt/flask-app/deployment.log

          log_success "Déploiement terminé avec succès"
